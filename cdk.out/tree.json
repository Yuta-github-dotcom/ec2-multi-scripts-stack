{"version":"tree-0.1","tree":{"id":"App","path":"","constructInfo":{"fqn":"aws-cdk-lib.App","version":"2.215.0"},"children":{"Ec2MultiPortMonitorStack":{"id":"Ec2MultiPortMonitorStack","path":"Ec2MultiPortMonitorStack","constructInfo":{"fqn":"aws-cdk-lib.Stack","version":"2.215.0"},"children":{"DefaultVPC":{"id":"DefaultVPC","path":"Ec2MultiPortMonitorStack/DefaultVPC","constructInfo":{"fqn":"aws-cdk-lib.Resource","version":"2.215.0","metadata":["*"]},"children":{"PublicSubnet1":{"id":"PublicSubnet1","path":"Ec2MultiPortMonitorStack/DefaultVPC/PublicSubnet1","constructInfo":{"fqn":"aws-cdk-lib.Resource","version":"2.215.0","metadata":["*"]}},"PublicSubnet2":{"id":"PublicSubnet2","path":"Ec2MultiPortMonitorStack/DefaultVPC/PublicSubnet2","constructInfo":{"fqn":"aws-cdk-lib.Resource","version":"2.215.0","metadata":["*"]}},"PublicSubnet3":{"id":"PublicSubnet3","path":"Ec2MultiPortMonitorStack/DefaultVPC/PublicSubnet3","constructInfo":{"fqn":"aws-cdk-lib.Resource","version":"2.215.0","metadata":["*"]}}}},"Ec2Role":{"id":"Ec2Role","path":"Ec2MultiPortMonitorStack/Ec2Role","constructInfo":{"fqn":"aws-cdk-lib.aws_iam.Role","version":"2.215.0","metadata":[{"assumedBy":{"principalAccount":"*","assumeRoleAction":"*"}},{"addManagedPolicy":[{"managedPolicyArn":"*"}]}]},"children":{"ImportEc2Role":{"id":"ImportEc2Role","path":"Ec2MultiPortMonitorStack/Ec2Role/ImportEc2Role","constructInfo":{"fqn":"aws-cdk-lib.Resource","version":"2.215.0","metadata":["*"]}},"Resource":{"id":"Resource","path":"Ec2MultiPortMonitorStack/Ec2Role/Resource","constructInfo":{"fqn":"aws-cdk-lib.aws_iam.CfnRole","version":"2.215.0"},"attributes":{"aws:cdk:cloudformation:type":"AWS::IAM::Role","aws:cdk:cloudformation:props":{"assumeRolePolicyDocument":{"Statement":[{"Action":"sts:AssumeRole","Effect":"Allow","Principal":{"Service":"ec2.amazonaws.com"}}],"Version":"2012-10-17"},"managedPolicyArns":[{"Fn::Join":["",["arn:",{"Ref":"AWS::Partition"},":iam::aws:policy/CloudWatchAgentServerPolicy"]]}]}}}}},"Linux2023Instance":{"id":"Linux2023Instance","path":"Ec2MultiPortMonitorStack/Linux2023Instance","constructInfo":{"fqn":"aws-cdk-lib.aws_ec2.Instance","version":"2.215.0","metadata":[{"instanceType":"*","machineImage":"*","vpc":"*","role":"*","userData":"*"}]},"children":{"InstanceSecurityGroup":{"id":"InstanceSecurityGroup","path":"Ec2MultiPortMonitorStack/Linux2023Instance/InstanceSecurityGroup","constructInfo":{"fqn":"aws-cdk-lib.aws_ec2.SecurityGroup","version":"2.215.0","metadata":[{"vpc":"*","allowAllOutbound":true,"allowAllIpv6Outbound":"*"}]},"children":{"Resource":{"id":"Resource","path":"Ec2MultiPortMonitorStack/Linux2023Instance/InstanceSecurityGroup/Resource","constructInfo":{"fqn":"aws-cdk-lib.aws_ec2.CfnSecurityGroup","version":"2.215.0"},"attributes":{"aws:cdk:cloudformation:type":"AWS::EC2::SecurityGroup","aws:cdk:cloudformation:props":{"groupDescription":"Ec2MultiPortMonitorStack/Linux2023Instance/InstanceSecurityGroup","securityGroupEgress":[{"cidrIp":"0.0.0.0/0","description":"Allow all outbound traffic by default","ipProtocol":"-1"}],"tags":[{"key":"Name","value":"Ec2MultiPortMonitorStack/Linux2023Instance"}],"vpcId":"vpc-00375577a5cba9ad6"}}}}},"InstanceProfile":{"id":"InstanceProfile","path":"Ec2MultiPortMonitorStack/Linux2023Instance/InstanceProfile","constructInfo":{"fqn":"aws-cdk-lib.aws_iam.CfnInstanceProfile","version":"2.215.0"},"attributes":{"aws:cdk:cloudformation:type":"AWS::IAM::InstanceProfile","aws:cdk:cloudformation:props":{"roles":[{"Ref":"Ec2Role2FD9A272"}]}}},"Resource":{"id":"Resource","path":"Ec2MultiPortMonitorStack/Linux2023Instance/Resource","constructInfo":{"fqn":"aws-cdk-lib.aws_ec2.CfnInstance","version":"2.215.0"},"attributes":{"aws:cdk:cloudformation:type":"AWS::EC2::Instance","aws:cdk:cloudformation:props":{"availabilityZone":"ap-northeast-1a","iamInstanceProfile":{"Ref":"Linux2023InstanceInstanceProfile2AC4A281"},"imageId":{"Ref":"SsmParameterValueawsserviceamiamazonlinuxlatestal2023amikernel61x8664C96584B6F00A464EAD1953AFF4B05118Parameter"},"instanceType":"t3.micro","securityGroupIds":[{"Fn::GetAtt":["Linux2023InstanceInstanceSecurityGroup9616A4D8","GroupId"]}],"subnetId":"subnet-0b57f1f8dbc42edd9","tags":[{"key":"Name","value":"Ec2MultiPortMonitorStack/Linux2023Instance"}],"userData":{"Fn::Base64":"#!/bin/bash\nyum install -y awscli\ncat << 'EOF' > /opt/port_check.sh\n#!/bin/bash\nNAMESPACE=\"Custom/PortCheck\"\nMETRIC_NAME=\"PortStatus\"\n\ndeclare -A targets=(\n  [example-rds.rds.amazonaws.com]=3306\n  [example.com]=443\n  [example.com]=22\n)\n\nfor HOST in \"${!targets[@]}\"; do\n  PORT=${targets[$HOST]}\n  timeout 5 bash -c \"</dev/tcp/$HOST/$PORT\" &>/dev/null\n  if [ $? -eq 0 ]; then STATUS=1; else STATUS=0; fi\n  aws cloudwatch put-metric-data \\\n    --namespace \"$NAMESPACE\" \\\n    --metric-name \"$METRIC_NAME\" \\\n    --value \"$STATUS\" \\\n    --dimensions Host=$HOST,Port=$PORT\ndone\nEOF\nchmod +x /opt/port_check.sh\n(crontab -l 2>/dev/null; echo \"*/5 * * * * /opt/port_check.sh\") | crontab -"}}}}}},"SsmParameterValue:--aws--service--ami-amazon-linux-latest--al2023-ami-kernel-6.1-x86_64:C96584B6-F00A-464E-AD19-53AFF4B05118.Parameter":{"id":"SsmParameterValue:--aws--service--ami-amazon-linux-latest--al2023-ami-kernel-6.1-x86_64:C96584B6-F00A-464E-AD19-53AFF4B05118.Parameter","path":"Ec2MultiPortMonitorStack/SsmParameterValue:--aws--service--ami-amazon-linux-latest--al2023-ami-kernel-6.1-x86_64:C96584B6-F00A-464E-AD19-53AFF4B05118.Parameter","constructInfo":{"fqn":"aws-cdk-lib.CfnParameter","version":"2.215.0"}},"SsmParameterValue:--aws--service--ami-amazon-linux-latest--al2023-ami-kernel-6.1-x86_64:C96584B6-F00A-464E-AD19-53AFF4B05118":{"id":"SsmParameterValue:--aws--service--ami-amazon-linux-latest--al2023-ami-kernel-6.1-x86_64:C96584B6-F00A-464E-AD19-53AFF4B05118","path":"Ec2MultiPortMonitorStack/SsmParameterValue:--aws--service--ami-amazon-linux-latest--al2023-ami-kernel-6.1-x86_64:C96584B6-F00A-464E-AD19-53AFF4B05118","constructInfo":{"fqn":"aws-cdk-lib.Resource","version":"2.215.0","metadata":[]}},"PortAlertTopic":{"id":"PortAlertTopic","path":"Ec2MultiPortMonitorStack/PortAlertTopic","constructInfo":{"fqn":"aws-cdk-lib.aws_sns.Topic","version":"2.215.0","metadata":[{"displayName":"*"}]},"children":{"Resource":{"id":"Resource","path":"Ec2MultiPortMonitorStack/PortAlertTopic/Resource","constructInfo":{"fqn":"aws-cdk-lib.aws_sns.CfnTopic","version":"2.215.0"},"attributes":{"aws:cdk:cloudformation:type":"AWS::SNS::Topic","aws:cdk:cloudformation:props":{"displayName":"Port Monitor Alert"}}},"yuhta.komatsu@gmail.com":{"id":"yuhta.komatsu@gmail.com","path":"Ec2MultiPortMonitorStack/PortAlertTopic/yuhta.komatsu@gmail.com","constructInfo":{"fqn":"aws-cdk-lib.aws_sns.Subscription","version":"2.215.0","metadata":[{"topic":"*","endpoint":"*","protocol":"email","filterPolicy":"*","filterPolicyWithMessageBody":"*","deadLetterQueue":"*"}]},"children":{"Resource":{"id":"Resource","path":"Ec2MultiPortMonitorStack/PortAlertTopic/yuhta.komatsu@gmail.com/Resource","constructInfo":{"fqn":"aws-cdk-lib.aws_sns.CfnSubscription","version":"2.215.0"},"attributes":{"aws:cdk:cloudformation:type":"AWS::SNS::Subscription","aws:cdk:cloudformation:props":{"endpoint":"yuhta.komatsu@gmail.com","protocol":"email","topicArn":{"Ref":"PortAlertTopic53A36549"}}}}}}}},"PortDownAlarm":{"id":"PortDownAlarm","path":"Ec2MultiPortMonitorStack/PortDownAlarm","constructInfo":{"fqn":"aws-cdk-lib.aws_cloudwatch.Alarm","version":"2.215.0","metadata":[{"metric":{"warnings":"*"},"threshold":"*","evaluationPeriods":"*","comparisonOperator":"*","alarmDescription":"*"},{"addAlarmAction":[{}]}]},"children":{"Resource":{"id":"Resource","path":"Ec2MultiPortMonitorStack/PortDownAlarm/Resource","constructInfo":{"fqn":"aws-cdk-lib.aws_cloudwatch.CfnAlarm","version":"2.215.0"},"attributes":{"aws:cdk:cloudformation:type":"AWS::CloudWatch::Alarm","aws:cdk:cloudformation:props":{"alarmActions":[{"Ref":"PortAlertTopic53A36549"}],"alarmDescription":"Port Down Detected","comparisonOperator":"LessThanThreshold","evaluationPeriods":1,"metricName":"PortStatus","namespace":"Custom/PortCheck","period":300,"statistic":"Minimum","threshold":1}}}}},"CDKMetadata":{"id":"CDKMetadata","path":"Ec2MultiPortMonitorStack/CDKMetadata","constructInfo":{"fqn":"constructs.Construct","version":"10.4.3"},"children":{"Default":{"id":"Default","path":"Ec2MultiPortMonitorStack/CDKMetadata/Default","constructInfo":{"fqn":"aws-cdk-lib.CfnResource","version":"2.215.0"}}}},"BootstrapVersion":{"id":"BootstrapVersion","path":"Ec2MultiPortMonitorStack/BootstrapVersion","constructInfo":{"fqn":"aws-cdk-lib.CfnParameter","version":"2.215.0"}},"CheckBootstrapVersion":{"id":"CheckBootstrapVersion","path":"Ec2MultiPortMonitorStack/CheckBootstrapVersion","constructInfo":{"fqn":"aws-cdk-lib.CfnRule","version":"2.215.0"}}}},"Tree":{"id":"Tree","path":"Tree","constructInfo":{"fqn":"constructs.Construct","version":"10.4.3"}}}}}