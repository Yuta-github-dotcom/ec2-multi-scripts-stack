{
 "Resources": {
  "Ec2Role2FD9A272": {
   "Type": "AWS::IAM::Role",
   "Properties": {
    "AssumeRolePolicyDocument": {
     "Statement": [
      {
       "Action": "sts:AssumeRole",
       "Effect": "Allow",
       "Principal": {
        "Service": "ec2.amazonaws.com"
       }
      }
     ],
     "Version": "2012-10-17"
    },
    "ManagedPolicyArns": [
     {
      "Fn::Join": [
       "",
       [
        "arn:",
        {
         "Ref": "AWS::Partition"
        },
        ":iam::aws:policy/CloudWatchAgentServerPolicy"
       ]
      ]
     }
    ]
   },
   "Metadata": {
    "aws:cdk:path": "Ec2MultiPortMonitorStack/Ec2Role/Resource"
   }
  },
  "Linux2023InstanceInstanceSecurityGroup9616A4D8": {
   "Type": "AWS::EC2::SecurityGroup",
   "Properties": {
    "GroupDescription": "Ec2MultiPortMonitorStack/Linux2023Instance/InstanceSecurityGroup",
    "SecurityGroupEgress": [
     {
      "CidrIp": "0.0.0.0/0",
      "Description": "Allow all outbound traffic by default",
      "IpProtocol": "-1"
     }
    ],
    "Tags": [
     {
      "Key": "Name",
      "Value": "Ec2MultiPortMonitorStack/Linux2023Instance"
     }
    ],
    "VpcId": "vpc-00375577a5cba9ad6"
   },
   "Metadata": {
    "aws:cdk:path": "Ec2MultiPortMonitorStack/Linux2023Instance/InstanceSecurityGroup/Resource"
   }
  },
  "Linux2023InstanceInstanceProfile2AC4A281": {
   "Type": "AWS::IAM::InstanceProfile",
   "Properties": {
    "Roles": [
     {
      "Ref": "Ec2Role2FD9A272"
     }
    ]
   },
   "Metadata": {
    "aws:cdk:path": "Ec2MultiPortMonitorStack/Linux2023Instance/InstanceProfile"
   }
  },
  "Linux2023Instance4FA12FC4": {
   "Type": "AWS::EC2::Instance",
   "Properties": {
    "AvailabilityZone": "ap-northeast-1a",
    "IamInstanceProfile": {
     "Ref": "Linux2023InstanceInstanceProfile2AC4A281"
    },
    "ImageId": {
     "Ref": "SsmParameterValueawsserviceamiamazonlinuxlatestal2023amikernel61x8664C96584B6F00A464EAD1953AFF4B05118Parameter"
    },
    "InstanceType": "t3.micro",
    "SecurityGroupIds": [
     {
      "Fn::GetAtt": [
       "Linux2023InstanceInstanceSecurityGroup9616A4D8",
       "GroupId"
      ]
     }
    ],
    "SubnetId": "subnet-0b57f1f8dbc42edd9",
    "Tags": [
     {
      "Key": "Name",
      "Value": "Ec2MultiPortMonitorStack/Linux2023Instance"
     }
    ],
    "UserData": {
     "Fn::Base64": "#!/bin/bash\nyum install -y awscli\ncat << 'EOF' > /opt/port_check.sh\n#!/bin/bash\nNAMESPACE=\"Custom/PortCheck\"\nMETRIC_NAME=\"PortStatus\"\n\ndeclare -A targets=(\n  [example-rds.rds.amazonaws.com]=3306\n  [example.com]=443\n  [example.com]=22\n)\n\nfor HOST in \"${!targets[@]}\"; do\n  PORT=${targets[$HOST]}\n  timeout 5 bash -c \"</dev/tcp/$HOST/$PORT\" &>/dev/null\n  if [ $? -eq 0 ]; then STATUS=1; else STATUS=0; fi\n  aws cloudwatch put-metric-data \\\n    --namespace \"$NAMESPACE\" \\\n    --metric-name \"$METRIC_NAME\" \\\n    --value \"$STATUS\" \\\n    --dimensions Host=$HOST,Port=$PORT\ndone\nEOF\nchmod +x /opt/port_check.sh\n(crontab -l 2>/dev/null; echo \"*/5 * * * * /opt/port_check.sh\") | crontab -"
    }
   },
   "DependsOn": [
    "Ec2Role2FD9A272"
   ],
   "Metadata": {
    "aws:cdk:path": "Ec2MultiPortMonitorStack/Linux2023Instance/Resource"
   }
  },
  "PortAlertTopic53A36549": {
   "Type": "AWS::SNS::Topic",
   "Properties": {
    "DisplayName": "Port Monitor Alert"
   },
   "Metadata": {
    "aws:cdk:path": "Ec2MultiPortMonitorStack/PortAlertTopic/Resource"
   }
  },
  "PortAlertTopicyuhtakomatsugmailcom07581A04": {
   "Type": "AWS::SNS::Subscription",
   "Properties": {
    "Endpoint": "yuhta.komatsu@gmail.com",
    "Protocol": "email",
    "TopicArn": {
     "Ref": "PortAlertTopic53A36549"
    }
   },
   "Metadata": {
    "aws:cdk:path": "Ec2MultiPortMonitorStack/PortAlertTopic/yuhta.komatsu@gmail.com/Resource"
   }
  },
  "PortDownAlarm56B890F4": {
   "Type": "AWS::CloudWatch::Alarm",
   "Properties": {
    "AlarmActions": [
     {
      "Ref": "PortAlertTopic53A36549"
     }
    ],
    "AlarmDescription": "Port Down Detected",
    "ComparisonOperator": "LessThanThreshold",
    "EvaluationPeriods": 1,
    "MetricName": "PortStatus",
    "Namespace": "Custom/PortCheck",
    "Period": 300,
    "Statistic": "Minimum",
    "Threshold": 1
   },
   "Metadata": {
    "aws:cdk:path": "Ec2MultiPortMonitorStack/PortDownAlarm/Resource"
   }
  },
  "CDKMetadata": {
   "Type": "AWS::CDK::Metadata",
   "Properties": {
    "Analytics": "v2:deflate64:H4sIAAAAAAAA/12SwW4aMRCGnyU+VmZbUNsDN5JIFVLTUIjUwwpFgz2AE9tjjW0Qsvbdq112ybYHy6PPM79/j2dWzabfqi93cI4Tpd8n1uyqskmg3uUaI2VWWItPQv63thLO8bUYcFVZk8W6CIgxO9T3FzEvIrDxygSwC6Uo+yTmXeE1py1YqGTId7hpZBGg9RN4OKBekTXqIuZ1EW5MFtynb5utfNj7VqXdlz4m8ApXTHtjsZGoZlUZaF2E6cOXS8DehwN1NB6XDg4DOgXVR0x2gDkiP0KC/mK5QZXZpMsPphzqMioCa+m8sPY5px1lr8U8ccYPvgyn7x9nV7WHvf9HcPyaRkYfq/JCwai6CG1isHD5BQ5H1d2p3ORdVGxC29C6iNTC3hV6Hcjc2h+YEimyYi7QgbFCir2xCXnoeZc1Rn9MOj5hjHDAe9JDhkbQPzEl5N8Z89jR2EsjlaWsz5DUsSoLC+zaP8XErb8izsDe+EO8lkuRjozxSFYP5k9gM7RKK2RDOvZckQvAJpJ/DsiQiG9/AOwe8WagF+6Gq7t+GLq6DEPU4aZpwxUwOEzIjfSksXqLn0+zr9V0Wk3v3qIxE84+GYfV+rr/BXT3xJs6AwAA"
   },
   "Metadata": {
    "aws:cdk:path": "Ec2MultiPortMonitorStack/CDKMetadata/Default"
   }
  }
 },
 "Parameters": {
  "SsmParameterValueawsserviceamiamazonlinuxlatestal2023amikernel61x8664C96584B6F00A464EAD1953AFF4B05118Parameter": {
   "Type": "AWS::SSM::Parameter::Value<AWS::EC2::Image::Id>",
   "Default": "/aws/service/ami-amazon-linux-latest/al2023-ami-kernel-6.1-x86_64"
  },
  "BootstrapVersion": {
   "Type": "AWS::SSM::Parameter::Value<String>",
   "Default": "/cdk-bootstrap/hnb659fds/version",
   "Description": "Version of the CDK Bootstrap resources in this environment, automatically retrieved from SSM Parameter Store. [cdk:skip]"
  }
 },
 "Rules": {
  "CheckBootstrapVersion": {
   "Assertions": [
    {
     "Assert": {
      "Fn::Not": [
       {
        "Fn::Contains": [
         [
          "1",
          "2",
          "3",
          "4",
          "5"
         ],
         {
          "Ref": "BootstrapVersion"
         }
        ]
       }
      ]
     },
     "AssertDescription": "CDK bootstrap stack version 6 required. Please run 'cdk bootstrap' with a recent version of the CDK CLI."
    }
   ]
  }
 }
}